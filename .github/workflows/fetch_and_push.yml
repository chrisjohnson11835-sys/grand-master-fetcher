      - name: Upload via SFTP (3x retry)
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASS: ${{ secrets.SFTP_PASS }}
          SFTP_DIR:  ${{ secrets.SFTP_DIR }}
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y sshpass

          tries=0
          until [ $tries -ge 3 ]; do
            echo "SFTP attempt $((tries+1))..."

            # Build an SFTP batch file (no YAML heredoc issues)
            cat > cmds.sftp <<CMDS
lcd out
cd "$SFTP_DIR"
mput -q *.json
bye
CMDS

            SSHPASS="$SFTP_PASS" sftp -oBatchMode=no -oStrictHostKeyChecking=no -P "$SFTP_PORT" \
              "$SFTP_USER@$SFTP_HOST" -b cmds.sftp && break

            tries=$((tries+1))
            echo "Retrying in 6s..."
            sleep 6
          done

          if [ $tries -ge 3 ]; then
            echo "SFTP failed after 3 attempts"; exit 1
          fi
